<head>
  <title>xpenz</title>

  <link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css" rel="stylesheet">

  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.66.0-2013.10.09/jquery.blockUI.min.js"></script>

  <link href="//cdn.rawgit.com/noelboss/featherlight/1.0.1/release/featherlight.min.css" type="text/css" rel="stylesheet" title="Featherlight Styles" />
  <script src="//cdn.rawgit.com/noelboss/featherlight/1.0.1/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>
</body>

<template name="mainScreen">
<div class="container">
	<h1 class="text-center">xpenz</h1>
	  {{#if currentUser}}
	  	{{> welcome}}

	  	{{> showUserExpenses}}

	  	{{#if isSuperAccountant}}
	  		{{> showExpensesToApprove }}
	  		{{> showExpensesToReimburse }}
	  	{{/if}}

	  	{{#if isManager}}
	  		{{> showExpensesToApprove }}
	  	{{/if}}

	  	{{#if isAccountant}}
	  		{{> showExpensesToReimburse }}
	  	{{/if}}
	  {{else}}
	 	 	
	 	 	{{#if needsToRegister}}
				{{> register}}
			{{else}}
				{{> login}}
			{{/if}}
	  {{/if}}
</div>
</template>

<!-- Templates  -->

<template name="OAuthReturn">

</template>

<template name="register">
<h3>Register a new account, <h5>{{name}}</h5></h3>
Email: <input id="email" type="email" />
Manager: <input id="managerId" type="managerId" />
<button id="registerButton">register</button>
</template>

<template name="login">
	<!-- 
	{{ loginMessage }}
	<input id="email" type="email" />
	<input id="password" type="password" />
	<button>Login</button>
	-->

	<a href="#" id="loginClick">Login with Dwolla</a>

</template>

<template name="welcome">
	{{#with currentUser}}
		Hi, {{profile.name}}.
	{{/with}}

	<button type="button" id="logoutButton" class="btn btn-small btn-warning">Logout</button>
</template>

<template name="showUserExpenses">
	<h3>your expenses</h3>
	{{> addNewExpense }}
	
	<div class="row expensesView">
		<table class="table">
			<thead>
				<tr>
					<th>Date</th>
					<th>Type</th>
					<th>Vendor</th>
					<th>Trip</th>
					<th>Description</th>
					<th>Amount</th>
					<th>Status</th>
				</tr>
			</thead>
			<tbody>
				{{#each getExpenses}}
					<tr>
						<td>{{date}}</td>
						<td>{{type}}</td>
						<td>{{vendor}}</td>
						<td>{{trip}}</td>
						<td>{{description}}</td>
						<td>{{amount}}</td>
						<td>{{status}}</td>
						<td>{{#if receiptFileURL}}
							<a href="{{receiptFileURL}}" data-lightbox="image-1" data-title="{{description}}">Receipt</a>
							{{else}}
							{{/if}}</td>
						{{#if ableToDelete}}
						<td>{{> quickRemoveButton collection=expensesCollection _id=this._id class="btn btn-danger"}}</td>
						{{/if}}
					</tr>
				{{/each}}
			</tbody>
		</table>
		</div>
</template>

<template name="addNewExpense">
{{ insertError }}
{{#autoForm collection=expenses id="insertExpenseForm" type="insert" class="form-inline"}}
<div class="row">
		<div class="col-lg-2">
			{{> afFieldInput name="date" placeholder="schemaLabel" id="expenseDateField"}}
		</div>
		<div class="col-lg-2">
			{{> afFieldInput name="trip" placeholder="schemaLabel"}}
		</div>
		<div class="col-lg-2">
			{{> afFieldInput name="vendor" placeholder="schemaLabel"}}
		</div>
		<div class="col-lg-2">
			{{> afFieldInput name="description" placeholder="schemaLabel"}}
		</div>
		<div class="col-lg-2">
			{{> afFieldInput name="type" options="allowed"}}
		</div>
		<div class="col-lg-2">
			<div class="input-group">
			  <span class="input-group-addon">$</span>
			  {{> afFieldInput name="amount" placeholder="schemaLabel" step="0.01" type="number" id="expenseAmountField"}}
			</div>
		</div>
		<div class="col-lg-2">
			<input type="file" class="file_bag">
	    {{#each files}}
	        <p>upload: {{percent_uploaded}}%</p>
	    {{/each}}
		</div>
</div>
<div class="row">
	<div class="col-lg-12">
		<button type="submit" class="btn btn-success btn-large" id="createExpenseButton">Create</button>
	</div>
</div>
{{/autoForm}}
</template>

<template name="showExpensesToApprove">
<div class="row expensesView">
	<h3>expenses to approve</h3>
	<table class="table">
		<thead>
			<tr>	
				<th>Employee</th>
				<th>Date</th>
				<th>Type</th>
				<th>Vendor</th>
				<th>Trip</th>
				<th>Description</th>
				<th>Amount</th>
				<th>Status</th>
			</tr>
		</thead>
		<tbody>
			{{#each getExpenses}}
				{{> displayExpenseRow }}
			{{/each}}
		</tbody>
	</table>
</div>
</template>

<template name="showExpensesToReimburse">
<div class="row expensesView">
	<h3>expenses to reimburse</h3>
	<table class="table">
		<thead>
			<tr>	
				<th>Employee</th>
				<th>Date</th>
				<th>Type</th>
				<th>Vendor</th>
				<th>Trip</th>
				<th>Description</th>
				<th>Amount</th>
				<th>Status</th>
			</tr>
		</thead>
		<tbody>
			{{#each getExpenses}}
				<input type="checkbox" class="expenseToReimburseCheckbox" value="{{_id}}">
				{{> displayExpenseRow }}
			{{/each}}
		</tbody>
	</table>

	<div class="row">
		{{#if reimburseError }}
			<div class="alert alert-danger" role="alert">{{ reimburseError }}</div>
		{{/if}}
		Reimburse the checked ones:
		<input type="password" id="PIN" placeholder="PIN" length="4" />
		<button type="submit" class="btn btn-primary btn-large reimburseCheckedExpensesButton">Reimburse</button>
	</div>
	
</div>

</template>

<template name="displayExpenseRow">
{{#with currentExpense}}
<tr>
	<td>{{#with getEmployee}} {{profile.name}} {{/with}}</td>
	<td>{{date}}</td>
	<td>{{type}}</td>
	<td>{{vendor}}</td>
	<td>{{trip}}</td>
	<td>{{description}}</td>
	<td>{{amount}}</td>
	<td>{{status}}</td>
	<td>
		{{#if receiptFileURL}}
			<a href="{{receiptFileURL}}" data-lightbox="image-1" data-title="{{description}}">Receipt</a>
		{{else}} 
			no receipt
		{{/if}}
	</td>

	{{#if ableToApprove}}
		<td>
			<button type="submit" class="btn btn-primary btn-large approveExpenseButton">Approve</button>
		</td>
	{{/if}}

	{{#if ableToApprove}}
		<td>
			<button type="submit" class="btn btn-danger btn-large rejectExpenseButton">Reject</button>
		</td>
	{{/if}}
	
	{{#if ableToReimburse}}
		<td>
			<button type="submit" class="btn btn-success btn-large reimburseExpenseButton">Pay</button>
		</td>
	{{/if}}
	
</tr>
{{/with}}
</template>